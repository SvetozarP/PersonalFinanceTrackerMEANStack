<div class="category-form-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="title-section">
      <h1>{{ isEditMode ? 'Edit Category' : 'New Category' }}</h1>
      <p class="subtitle">{{ isEditMode ? 'Update category details' : 'Create a new financial category' }}</p>
    </div>
    <div class="actions-section">
      <button class="btn btn-secondary" (click)="onCancel()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
    </div>
  </div>

  <!-- Error Display -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </div>

  <!-- Main Loading State -->
  <div *ngIf="isFormLoading" class="loading-container">
    <app-loading-spinner 
      message="Loading category data..." 
      size="large" 
      [overlay]="false">
    </app-loading-spinner>
  </div>

  <!-- Form Content -->
  <div *ngIf="!isFormLoading" class="form-content">
    <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()" class="category-form">
      <div class="form-sections">
        
        <!-- Basic Information Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-info-circle"></i>
            Basic Information
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="name">Category Name *</label>
              <input
                type="text"
                id="name"
                formControlName="name"
                class="form-control"
                [class.is-invalid]="isFieldInvalid('name')"
                placeholder="Enter category name"
              />
              <div *ngIf="isFieldInvalid('name')" class="invalid-feedback">
                {{ getFieldError('name') }}
              </div>
            </div>

            <div class="form-group">
              <label for="description">Description</label>
              <textarea
                id="description"
                formControlName="description"
                class="form-control"
                rows="3"
                placeholder="Optional description for this category"
              ></textarea>
              <small class="form-text">Maximum 200 characters</small>
            </div>
          </div>
        </div>

        <!-- Visual Customization Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-palette"></i>
            Visual Customization
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="color">Color *</label>
              <div class="color-picker">
                <div class="color-preview" [ngStyle]="getPreviewStyle()">
                  <span class="preview-icon" [title]="getIconDescription(getFieldControl('icon')?.value || 'üè∑Ô∏è')">{{ getFieldControl('icon')?.value || 'üè∑Ô∏è' }}</span>
                </div>
                <input
                  type="color"
                  id="color"
                  formControlName="color"
                  class="color-input"
                  [class.is-invalid]="isFieldInvalid('color')"
                />
              </div>
              <div class="color-options">
                <div class="color-option-label">Quick Select:</div>
                <div class="color-grid">
                  <button
                    *ngFor="let color of colorOptions"
                    type="button"
                    class="color-option"
                    [style.background-color]="color"
                    [class.selected]="getFieldControl('color')?.value === color"
                    (click)="onColorSelect(color)"
                    [attr.aria-label]="'Select color ' + color"
                  ></button>
                </div>
              </div>
              <div *ngIf="isFieldInvalid('color')" class="invalid-feedback">
                {{ getFieldError('color') }}
              </div>
            </div>

            <div class="form-group">
              <label for="icon">Icon *</label>
              <div class="icon-picker">
                <div class="icon-preview" [ngStyle]="getPreviewStyle()">
                  <span class="preview-icon" [title]="getIconDescription(getFieldControl('icon')?.value || 'üè∑Ô∏è')">{{ getFieldControl('icon')?.value || 'üè∑Ô∏è' }}</span>
                </div>
                <div class="icon-options">
                  <div class="icon-option-label">Quick Select:</div>
                  <div class="icon-grid">
                    <button
                      *ngFor="let icon of iconOptions"
                      type="button"
                      class="icon-option"
                      [class.selected]="getFieldControl('icon')?.value === icon"
                      (click)="onIconSelect(icon)"
                      [attr.aria-label]="'Select icon ' + icon"
                      [title]="getIconDescription(icon)"
                    >
                      {{ icon }}
                    </button>
                  </div>
                </div>
              </div>
              <div *ngIf="isFieldInvalid('icon')" class="invalid-feedback">
                {{ getFieldError('icon') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Category Hierarchy Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-sitemap"></i>
            Category Hierarchy
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="parentId">Parent Category</label>
              <div class="parent-category-selector">
                <div *ngIf="isParentCategoriesLoading" class="loading-overlay">
                  <app-loading-spinner 
                    message="Loading categories..." 
                    size="small">
                  </app-loading-spinner>
                </div>
                
                <select
                  id="parentId"
                  formControlName="parentId"
                  class="form-control"
                  (change)="onParentCategoryChange($any($event.target).value)">
                  <option value="">No Parent (Top Level)</option>
                  <option *ngFor="let category of getParentCategories()" [value]="category._id">
                    {{ getCategoryPath(category._id) }}
                  </option>
                </select>
                <small class="form-text">
                  Leave empty to create a top-level category. 
                  Only active, non-system categories can be selected as parents.
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-toggle-on"></i>
            Status & Settings
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  formControlName="isActive"
                  class="form-checkbox"
                />
                <span class="checkmark"></span>
                Category is active
              </label>
              <small class="form-text">
                Inactive categories won't appear in transaction forms or reports
              </small>
            </div>
          </div>
        </div>

        <!-- Preview Section -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-eye"></i>
            Preview
          </h3>
          
          <div class="preview-container">
            <div class="category-preview" [ngStyle]="getPreviewStyle()">
              <div class="preview-content">
                <span class="preview-icon" [title]="getIconDescription(getFieldControl('icon')?.value || 'üè∑Ô∏è')">{{ getFieldControl('icon')?.value || 'üè∑Ô∏è' }}</span>
                <div class="preview-details">
                  <div class="preview-name">{{ getFieldControl('name')?.value || 'Category Name' }}</div>
                  <div class="preview-description" *ngIf="getFieldControl('description')?.value">
                    {{ getFieldControl('description')?.value }}
                  </div>
                </div>
              </div>
              <div class="preview-badge">
                {{ getFieldControl('parentId')?.value ? 'Subcategory' : 'Top Level' }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="left-actions">
          <button type="button" class="btn btn-outline-secondary" (click)="resetForm()">
            <i class="fas fa-undo"></i>
            Reset
          </button>
        </div>
        
        <div class="right-actions">
          <button type="button" class="btn btn-secondary" (click)="onCancel()">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!canSubmit()">
            <i class="fas" [class.fa-save]="!isSubmitting" [class.fa-spinner]="isSubmitting"></i>
            {{ isSubmitting ? 'Saving...' : (isEditMode ? 'Update Category' : 'Create Category') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>