<div class="dashboard-container">
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-container">
      <app-loading-spinner [size]="'large'" [message]="'Loading dashboard...'"></app-loading-spinner>
    </div>
  
    <!-- Error State -->
    <div *ngIf="error() && !isLoading()" class="error-container">
      <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error() }}</span>
        <button class="btn btn-primary" (click)="refreshDashboard()">
          <i class="fas fa-redo"></i>
          Retry
        </button>
      </div>
    </div>
  
    <!-- Dashboard Content -->
    <div *ngIf="isDataLoaded()" class="dashboard-content">
      <!-- Header Section -->
      <div class="header-section">
        <div class="title-section">
          <h1>Financial Dashboard</h1>
          <p class="subtitle">Overview of your financial health</p>
        </div>
        <div class="actions-section">
          <!-- Date Range Controls -->
          <div class="date-range-controls">
            <label>Time Period:</label>
            <div class="date-buttons">
              <button class="btn btn-sm btn-outline-primary" (click)="setLastMonth()">Last Month</button>
              <button class="btn btn-sm btn-outline-primary" (click)="setLast3Months()">Last 3 Months</button>
              <button class="btn btn-sm btn-outline-primary" (click)="setLast6Months()">Last 6 Months</button>
              <button class="btn btn-sm btn-outline-primary" (click)="setLastYear()">Last Year</button>
            </div>
          </div>
          
          <button class="btn btn-secondary" (click)="refreshDashboard()" [disabled]="isLoading()">
            <i class="fas fa-redo"></i>
            Refresh
          </button>
          <button class="btn btn-primary" routerLink="/financial/transactions/new">
            <i class="fas fa-plus"></i>
            New Transaction
          </button>
          <button class="btn btn-danger" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
  
      <!-- Currency-Separated Overview Cards -->
      <div class="currency-dashboard-overview" *ngIf="currencyDashboards() && currencyDashboards()!.size > 0">
        <div class="currency-section" *ngFor="let currencyEntry of currencyDashboards() | keyvalue">
          <div class="currency-header">
            <h2>{{ currencyEntry.key }} Financial Overview</h2>
          </div>
          
          <div class="overview-section">
            <div class="overview-grid">
              <!-- Total Balance Card -->
              <div class="overview-card balance-card">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-wallet"></i>
                  </div>
                  <div class="card-title">Total Balance</div>
                </div>
                <div class="card-value">
                  {{ formatCurrency(currencyEntry.value.overview.totalBalance, currencyEntry.key) }}
                </div>
                <div class="card-change" [class]="getChangeClass(currencyEntry.value.overview.monthlyNet)">
                  <span class="change-indicator">{{ getChangeIndicator(currencyEntry.value.overview.monthlyNet) }}</span>
                  <span class="change-value">{{ formatCurrency(currencyEntry.value.overview.monthlyNet, currencyEntry.key) }}</span>
                  <span class="change-period">this month</span>
                </div>
              </div>

              <!-- Monthly Income Card -->
              <div class="overview-card income-card">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-arrow-down"></i>
                  </div>
                  <div class="card-title">Monthly Income</div>
                </div>
                <div class="card-value">
                  {{ formatCurrency(currencyEntry.value.overview.monthlyIncome, currencyEntry.key) }}
                </div>
                <div class="card-subtitle">Total incoming funds</div>
              </div>

              <!-- Monthly Expenses Card -->
              <div class="overview-card expense-card">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-arrow-up"></i>
                  </div>
                  <div class="card-title">Monthly Expenses</div>
                </div>
                <div class="card-value">
                  {{ formatCurrency(currencyEntry.value.overview.monthlyExpenses, currencyEntry.key) }}
                </div>
                <div class="card-subtitle">Total outgoing funds</div>
              </div>

              <!-- Monthly Net Card -->
              <div class="overview-card net-card">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="card-title">Monthly Net</div>
                </div>
                <div class="card-value" [class]="getChangeClass(currencyEntry.value.overview.monthlyNet)">
                  {{ formatCurrency(currencyEntry.value.overview.monthlyNet, currencyEntry.key) }}
                </div>
                <div class="card-subtitle">Income - Expenses</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fallback: Single Currency Overview (when no currency data available) -->
      <div class="metrics-grid" *ngIf="!currencyDashboards() || currencyDashboards()!.size === 0">
        <!-- Total Balance -->
        <div class="metric-card balance">
          <div class="metric-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="metric-content">
            <div class="metric-label">Total Balance</div>
            <div class="metric-value">{{ getTotalBalance() | currency }}</div>
            <div class="metric-change positive">
              <i class="fas fa-arrow-up"></i>
              +{{ getSavingsRate() | number:'1.1-1' }}%
            </div>
          </div>
        </div>
  
        <!-- Total Income -->
        <div class="metric-card income">
          <div class="metric-icon">
            <i class="fas fa-arrow-down"></i>
          </div>
          <div class="metric-content">
            <div class="metric-label">Total Income</div>
            <div class="metric-value">{{ getTotalIncome() | currency }}</div>
            <div class="metric-period">This Month</div>
          </div>
        </div>
  
        <!-- Total Expenses -->
        <div class="metric-card expenses">
          <div class="metric-icon">
            <i class="fas fa-arrow-up"></i>
          </div>
          <div class="metric-content">
            <div class="metric-label">Total Expenses</div>
            <div class="metric-value">{{ getTotalExpenses() | currency }}</div>
            <div class="metric-period">This Month</div>
          </div>
        </div>
  
        <!-- Net Worth -->
        <div class="metric-card networth">
          <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="metric-content">
            <div class="metric-label">Net Worth</div>
            <div class="metric-value">{{ getNetWorth() | currency }}</div>
            <div class="metric-period">Current</div>
          </div>
        </div>
      </div>
  
        <!-- Charts Section -->
        <div class="charts-section">
          <!-- Spending Trend - Modern Line Chart -->
          <div class="chart-card full-width">
            <app-modern-chart
              [data]="spendingChartData()"
              [type]="'line'"
              [title]="'Spending Trend'"
              [loading]="isLoading()"
              [emptyMessage]="'No spending data available'"
              [allowFullscreen]="true">
            </app-modern-chart>
          </div>

          <!-- Income Trend - Modern Bar Chart -->
          <div class="chart-card full-width">
            <app-modern-chart
              [data]="incomeChartData()"
              [type]="'bar'"
              [title]="'Income Trend'"
              [loading]="isLoading()"
              [emptyMessage]="'No income data available'"
              [allowFullscreen]="true">
            </app-modern-chart>
          </div>

          <!-- Category Spending - Modern Pie Chart -->
          <div class="chart-card full-width">
            <app-modern-chart
              [data]="categoryChartData()"
              [type]="'pie'"
              [title]="'Spending by Category'"
              [loading]="isLoading()"
              [emptyMessage]="'No category data available'"
              [allowFullscreen]="true">
            </app-modern-chart>
          </div>
        </div>
  
      <!-- Recent Transactions -->
      <div class="recent-transactions-section">
        <div class="section-header">
          <h3>Recent Transactions</h3>
          <div class="section-actions">
            <button class="btn btn-sm btn-secondary" (click)="refreshTransactions()" [disabled]="isRecentTransactionsLoading()">
              <i class="fas fa-redo"></i>
              Refresh
            </button>
            <button class="btn btn-sm btn-primary" routerLink="/financial/transactions">
              View All
            </button>
          </div>
        </div>
        
        <div class="transactions-content">
          <div *ngIf="isRecentTransactionsLoading()" class="transactions-loading">
            <app-loading-spinner [size]="'medium'" [message]="'Loading transactions...'"></app-loading-spinner>
          </div>
          
          <div *ngIf="!isRecentTransactionsLoading() && recentTransactions() && recentTransactions().length > 0" class="transactions-list">
            <div *ngFor="let transaction of recentTransactions()" class="transaction-item">
              <div class="transaction-icon">
                <i class="fas fa-credit-card"></i>
              </div>
              <div class="transaction-details">
                <div class="transaction-title">{{ transaction.title }}</div>
                <div class="transaction-category">{{ transaction.categoryId ? getCategoryName(transaction.categoryId) : 'Unknown' }}</div>
                <div class="transaction-date">{{ transaction.date | date:'shortDate' }}</div>
              </div>
              <div class="transaction-amount" [class.negative]="transaction.type === 'expense'" [class.positive]="transaction.type === 'income'">
                {{ transaction.amount | currency }}
              </div>
            </div>
          </div>
          
          <div *ngIf="!isRecentTransactionsLoading() && (!recentTransactions() || recentTransactions().length === 0)" class="transactions-empty">
            <i class="fas fa-receipt"></i>
            <p>No recent transactions</p>
            <button class="btn btn-primary" routerLink="/financial/transactions/new">
              Add First Transaction
            </button>
          </div>
        </div>
      </div>
  
      <!-- Quick Actions -->
      <div class="quick-actions-section">
        <div class="section-header">
          <h3>Quick Actions</h3>
        </div>
        <div class="actions-grid">
          <button class="action-card" routerLink="/financial/transactions/new">
            <div class="action-icon">
              <i class="fas fa-plus"></i>
            </div>
            <div class="action-label">New Transaction</div>
          </button>
          <button class="action-card" routerLink="/financial/categories/new">
            <div class="action-icon">
              <i class="fas fa-tags"></i>
            </div>
            <div class="action-label">New Category</div>
          </button>
          <button class="action-card" routerLink="/financial/reports">
            <div class="action-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div class="action-label">View Reports</div>
          </button>
          <button class="action-card" routerLink="/financial/budgets">
            <div class="action-icon">
              <i class="fas fa-piggy-bank"></i>
            </div>
            <div class="action-label">Manage Budgets</div>
          </button>
        </div>
      </div>
    </div>
  </div>